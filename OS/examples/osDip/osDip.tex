\documentclass[11pt]{article}
\usepackage{graphics,graphicx}
%\usepackage[dvips]{graphics,graphicx}
\DeclareGraphicsExtensions{.ps,.jpg,.eps,.pdf,.png}
\usepackage{boxedminipage,amsmath,amsfonts}
\usepackage{url}
\usepackage{./own}
%\usepackage{secdot}
%\usepackage{natbib}
\usepackage{verbatim}
%\usepackage{moreverb}
\usepackage{enumerate}
\usepackage{makeidx}
\bibliographystyle{plain}
\makeindex
     
     
%%%%%
% some other macros
\newcommand{\figurepath}{./figures}
\newcommand{\bibpath}{/Users/kmartin/Documents/files/misc}
\newcommand{\figfiletype}{pdf}

%Brad Bell Macros

% Latex macros defined for all the CppAD documentation:
\newcommand{\T}{ {\rm T} }
\newcommand{\R}{ {\bf R} }
\newcommand{\C}{ {\bf C} }
\newcommand{\D}[2]{ \frac{\partial #1}{\partial #2} }
\newcommand{\DD}[3]{ \frac{\partial^2 #1}{\partial #2 \partial #3} }
\newcommand{\Dpow}[2]{ \frac{\partial^{#1}}{\partial  {#2}^{#1}} }
\newcommand{\dpow}[2]{ \frac{ {\rm d}^{#1}}{{\rm d}\, {#2}^{#1}} }

% Define the hangref environment used for the References list:
\newenvironment{hangref}
  {\begin{list}{}{\setlength{\itemsep}{4pt}
  \setlength{\parsep}{0pt}\setlength{\leftmargin}{+\parindent}
  \setlength{\itemindent}{-\parindent}}}{\end{list}}

% Set the page margins to 1 inch all around:
\marginparwidth 0pt\marginparsep 0pt \topskip 0pt\headsep
0pt\headheight 0pt \oddsidemargin 0pt\evensidemargin 0pt
\textwidth 6.5in \topmargin 0pt\textheight 9.0in
\newtheorem{theorem}{Theorem}

   
%%%%Added by Leo%%%%
\newcounter{Fig}
\renewcommand{\theFig}{\arabic{Fig}}
\newcommand{\Fig}[2]{\refstepcounter{Fig} \label{#1}
                     {\small\bf Figure \theFig.} {\small\sl #2 \par}}

\setcounter{topnumber}{3}
\renewcommand{\topfraction}{.9}
\setcounter{bottomnumber}{3}
\renewcommand{\bottomfraction}{.9}
\setcounter{totalnumber}{4}
\renewcommand{\textfraction}{.1}
\setlength{\floatsep}{.25in}
\setlength{\intextsep}{.25in}

\setlength{\fboxrule}{2\fboxrule} \setlength{\fboxsep}{3\fboxsep}

\newcommand{\Sa}{8pt}
\newcommand{\Sb}{0pt}

\renewcommand{\_}{{\char"5F}}
\renewcommand{\{}{{\char"7B}}
\renewcommand{\}}{{\char"7D}}
\renewcommand{\^}{{\char"0D}}

\let\accute= \'
\renewcommand{\'}{{\char"0D}}

\newcommand{\bfit}{\bfseries\itshape}

\newlength{\extopskip} \newlength{\exbottomskip}
\setlength{\exbottomskip}{1\baselineskip}
\addtolength{\exbottomskip}{-5.0pt}
\setlength{\extopskip}{1\exbottomskip}
\addtolength{\extopskip}{-1\parskip}

\newenvironment{Example}{\vspace{1\extopskip}\noindent\hspace*{2em}
                         \frenchspacing\small
                         \tt\begin{tabular}{@{}l@{}}}{
                         \end{tabular}\\[1\exbottomskip]}

\newcommand{\Titem}{\item[$\triangleright$]}
\newcommand{\Ditem}{\item[$\diamond$]}

\newenvironment{Itemize}{\begin{quote}\normalsize
   \baselineskip 20pt plus .3pt minus .1pt \begin{itemize}}
   {\end{itemize}\end{quote}}
   % Set path to folder containing figures
\newcommand{\FigureFolder}{figures}




\begin{document}



\title{Using Dip With OS}
\vskip 2in
\author{Horand Gassmann, Jun Ma,  Kipp Martin}
\maketitle

\begin{abstract}
In this document we describe how to use the Decomposition in Integer Programming
(Dip) package with the Optimization Services (OS) package.  The code for this example is contained in the folder {\tt  OS/examples/osDip.}

\end{abstract}


\newpage
%\tableofcontents
%\listoffigures
%\listoftables
\hyphenation{com-plex-Type}


 

%\noindent\hrulefill
\newpage

\section{Using the OS-Dip Example}

Currently, the Decomposition in Integer Programming ({\bf Dip} package is not a dependency of the Optimization Services ({\bf OS}) package.  In order to run the {\bf osDip} example it is necessary to download both the {\bf OS} and {\bf  Dip} package. Download order is not relevant. In the discussion that follows we assume that for both {\bf OS} and {\bf Dip} the user has successfully completed a {\tt configure}, {\tt make}, and {\tt make install}.



I have tested this on several simple plant location problems and generalized
assignment problems. I have tested on both the Mac and Linux and it seems to be
working. The configure step should generate a working Makefile for your platform.
The OS project still does not include Dip as an external so you need to point to
the Dip root. There is a variable in the generated Makefile,

DIPPATH =

that need to be filled in after configure. This "should" be the only line in the
Makefile you need to edit. So on my machine, I have

DIPPATH = /Users/kmartin/coin/dip-trunk/vpath/

and there exists a directory

/Users/kmartin/coin/dip-trunk/vpath/lib

with the necessary libs and a directory

DIPPATH = /Users/kmartin/coin/dip-trunk/vpath/include

with the necessary headers.

After building the executable run

./osdip --param osdip.parm

Look at the osdip.parm file. You can see by commenting and uncommenting you can
run one of three problems that will also get downloaded.

sp1.osil -- a simple plant location problem spl2.osil -- a second simple plant
location problem genAssign.osil -- a generalize assignment problem

The osol files (the option files) determine behavior. For example, if you use

osolFiles/spl1-b.osol

then the assingment constraints are the block constraints. If you use

osolFiles/spl1.osol

then the setup forcing constraints are the block constraints.  This  new  example
also exhibits the problems I filed ticked on.



\section{Simple Plant/Lockbox Location Example}


 The problem minimizing
the sum of the cost of capital due to float  and the cost of operating the lock boxes is the
 problem.  

\noindent {\bf Parameters:}
\begin{itemize}
\item[]  $m -$ number of customers to be assigned a lock box

\item[]  $n -$ number of potential lock box sites

\item[]  $c_{ij} -$ annual cost of capital associated with serving customer $j$ from lock box $i$ 

\item[]  $f_{i} -$  annual fixed cost of operating a lock box at location $i$
\end{itemize}

\noindent {\bf Variables:}
\begin{itemize}

\item[]  $x_{ij} - $ a binary variable which is equal to 1 if customer $j$ is assigned to lock box $i$
and 0 if not

\item[]  $y_{i} - $ a binary variable which is equal to 1 if the lock box at location $i$ is opened and 0 if
not

\end{itemize}
The   integer linear program  for the lock box location problem is
$$
\eqnarrayx{
  & \min  &\sum_{i = 1}^{n} \sum_{j = 1}^{m} c_{ij} x_{ij}& + &\sum_{i = 1}^{n} f_{i} y_{i} &&&&&
\eq{eq:lockobj} \cr
(LB) &{\rm s.t.} & \sum_{i = 1}^{n} x_{ij} &=& 1, & j = 1, \ldots, m &&&&\eq{eq:lockdemand} \cr
&&x_{ij} - y_{i} &\le& 0, & i = 1, \ldots, n, & j = 1, \ldots, m &&& \eq{eq:locksetup} \cr
&& x_{ij}, \, \, y_{i} &\in& \{ 0, 1 \}, & i = 1, \ldots, n, & j = 1, \ldots, m. &&&\eq{eq:lockbinary}
\cr
}
$$

The objective (\ref{eq:lockobj}) is to minimize the sum of the cost of capital plus the fixed cost of
operating the lock boxes.  The requirement that every customer be assigned a lock box is modeled by
constraint (\ref{eq:lockdemand}).   Constraints (\ref{eq:locksetup})  are forcing  constraints and
play the same role as constraint set (\ref{eq:mpdlsfixcharge}) in the dynamic lot size model.   

\vskip 10pt
{\bf Location Example 1:} A three-by-five example.

\vskip 12pt

\begin{center}
\begin{tabular}{|cc|c|c|} \hline
       &    & CUSTOMER &         \\
      &     &\begin{tabular}{ccccc}
             1&2&3&4&5 \end{tabular} & FIXED COSTS  \\ \hline
     &   1   &\begin{tabular}{ccccc}
             2&3&4&5&7 \end{tabular} &   2  \\
 PLANT & 2   &\begin{tabular}{ccccc}
             4  &  3  &  1  &  2  &  6 \end{tabular} &  3  \\    
       & 3   &\begin{tabular}{ccccc}
            5   &  4  &  2  &  1  &  3 \end{tabular} &  3  \\   \hline
\end{tabular}     
\end{center}                         


\vskip 12pt

{\bf Location Example 2:} A three-by-three example.

\vskip 10pt
$\min                                                    
2x_{11}+x_{12}+x_{13}+x_{21}+2x_{22}+x_{23}+x_{31}+x_{32}+2x_{33}+
y_{1}+y_{2}+y_{3}$


\[
\begin{array}{llll}
{\rm s.t.} &x_{11}+x_{21}+x_{31} = 1 & & \\
&x_{12}+x_{22}+x_{32} = 1 & &   \\
&x_{13}+x_{23}+x_{33} = 1 & &
\end{array}   Ax \ge b \,\, {\rm constraints}
  \]
  
  
\begin{eqnarray*}
\begin{array}{lll}
x_{11}\leq y_{1}\leq 1 & &  \\
x_{12}\leq y_{1}\leq 1 & & \\
x_{13}\leq y_{1}\leq 1 & & \\
x_{21}\leq y_{2}\leq 1 & & \\
x_{22}\leq y_{2}\leq 1 & &   \\
x_{23}\leq y_{2}\leq 1 & & \\
x_{31}\leq y_{3}\leq 1 & & \\
x_{32}\leq y_{3}\leq 1 & &\\
x_{33}\leq y_{3}\leq 1 & &\\ 
\end{array}
 Bx \ge b \,\, {\rm constraints} \\
x_{ij},y_{i}\ge 0 , \,\, i = 1, \ldots, n, \, \, j = 1, \ldots, m.   
\end{eqnarray*}






\section{Generalized Assignment Problem Example}

A problem that plays a prominent role in
vehicle routing is the {\it generalized assignment problem.}    The problem is to assign each of $n$
tasks to $m$ servers without exceeding the resource capacity of the servers.

\noindent{\bf Parameters:}
\begin{itemize}
\item[]  $n -$ number of required tasks
\item[]  $m -$   number of servers
\item[]  $f_{ij} -$ cost of assigning task $i$ to server $j$
\item[]  $b_{j} -$  units of resource available to server $j$
\item[]  $a_{ij} -$ units of server $j$ resource required to perform task $i$
\end{itemize}

\noindent{\bf Variables:}
\begin{itemize}
\item[]  $x_{ij} -$ a binary variable which is equal to 1 if task $i$ is assigned to server $j$
and 0 if not
\end{itemize}
The integer linear program for the generalized assignment problem  is 
$$
\eqnarrayx{
&  \min &\sum_{i = 1}^{n} \sum_{j = 1}^{m} f_{ij} x_{ij} &&&&&&& \eq{eq:gapobj} \cr
(GAP) &{\rm s.t.}& \sum_{j = 1}^{m} x_{ij} &=& 1, & i = 1, \ldots, n  &&&& \eq{eq:gapassign} \cr
&& \sum_{i = 1}^{n} a_{ij} x_{ij} &\le& b_{j}, &j = 1, \ldots, m  &&&&\eq{eq:gapcapacity}  \cr
&& x_{ij} &\in& \{ 0, 1 \}, & i = 1, \ldots, n, & j = 1, \ldots, m.  &&&
\eq{eq:gapbinary}  \cr
}
$$

The objective function (\ref{eq:gapobj}) is to minimize the total assignment cost.  Constraint
(\ref{eq:gapassign}) requires that each task is assigned a server.  The requirement that the
server capacity not be exceeded is given in (\ref{eq:gapcapacity}). 

The test problem


\begin{verbatim}
 min     2 X11 + 11 X12 + 7 X21 + 7 X22 + 20 X31 + 
2 X32 + 5 X41 + 5 X42
s.t.
X11 + X12 =    1
X21 + X22 =    1
X31 + X32 =    1
X41 + X42 =    1

3 X11 + 6 X21 + 5 X31 + 7 X41 <=   13
2 X12 + 4 X22 + 10 X32 + 4 X42 <=   10
\end{verbatim}

\end{document}

configure - using command line or configure file

for example on lehigh machines that have cplex, my config file is:



# COIN config.site file for common autotools settings
#enable_debug=yes

#use CPLEX
with_lp_solver=cplex
with_ip_solver=cplex

#location of CPLEX
with_cplex_incdir="/usr/local/cplex/include/ilcplex"
with_cplex_lib="-L/usr/local/cplex/lib/x86-64_debian4.0_4.1/static_pic -lcplex -lpthread"



%%%%%%%%%%%%%%%%%%%%%

Matt sept 7


CC'ing DIP list.


I ran the GAP example for  VERSION1. Got it to run with no problem. Very useful. I was hoping you could clarify the folloiwng.

1) It looks like the only place where the blocks get defined are in 235-238:

for(i = 0; i < nMachines; i++){
modelName = "KP" + UtilIntToStr(i);
setModelRelax(NULL, modelName, i);
}

It looks like you are NOT creating a DecompConstraintSet for each block and you
are NOT specifying the variables that go into the blocks. Is this correct? You
simply tell the master how many blocks there are with setModelRelax().


That is correct. There is no "explicit" polyhedron in this example. It is
implicitly defined by the oracle (solveRelaxed).






2) In the solveRelaxed() method, I assume that the redCostX array contains a
reduced cost FOR EVERY variable. Is this true? I guess it must be since I have
not told the master which variables are in which block.  Of course I see the line

const double   * redCostXB   = redCostX + getOffsetI(whichBlock);

which implies maybe redCostX is only the variables for whichBlock? But then I
have not specified the variables in whichBlock. I am confused here and this seems
like a key point.


redCostX is, in fact, for every variable. You will also notice in the arguments
the "whichBlock" that tells you which block you are suppose to solve in that
call. The redCostXB defines the starting point for the reduced costs for block
`whichBlock`. It uses the user-defined 'getOffsetI' function. Since this is a
user-defined oracle, they are responsible for keeping track of which variables
correspond to which blocks. The framework doesn't really need to know that -
since the polyhedron is defined implicitly.




3) This question is related to 2). What if I define "master only" variables.  Do
the "master only" variables reduced cost get included in redCostX in
solveRelaxed()? If you are not telling the master which variables go into which
block, then I guess the concept of "master only" variables is not really needed
or is moot. Correct? Just pass all variable to solveRelaxed(). In my case I do
have variables that appear only in the master. Should I declare these?


Yes, master-only would be included in redCostX and as a user you would want to
ignore them. Each master-only is considered its own block and is dealt with
internally. I guess I should add an example that shows implicit polyhdreon and
master-only variables? Is that the case you have? If so, I can work on that soon.
Yes, you should delcare them and explicitly state them as master-only.






4) This is related to 3). If indeed, redCostX is the vector of all variables then
I suppose I could easily do what I wrote you about earlier this  summer, namely
solve the blocks in parallel. That is I could take redCostX and in my own code,
in parallel solve a problem for each block and then when each solveRelaxed() is
called in turn, give it the solution from my parallel solve. Does this make
sense?


Not yet. Two issues there. (1) the logic by default is to loop over all blocks
and call the solveRelaxed for each value of whichBlock. So, if you solved all in
parallel, you'd get too many. You, could, of course, just solve the "first one"
for all and then skip the rest. But, that is an ugly hack. (2) The argument
convexDual is the dual associated with the convexity constraint for `whichBlock`.
To do what you want, you really need all the duals for the convexity constraint.
Again, you could "get this" by grabbing the full dual vector from the master LP
and parsing it yourself - but that gets tricky when you add in cut and branch
constraints to the master -- the accounting is tricky.

The better approach is for me to provide you an API for doing what you want. I
have not got around to that yet: https://projects.coin-or.org/Dip/ticket/30




% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



Master-only variables need to be dealt with special. Because of the design of
DIP, it relies on a mapping between the compact and extended space. If there are
no master-only vars, this is clearly just x=sum{b} sum{s} lambda^b_s s, where s
is a vector in projected space of x (for each block).

With master-only vars, this only works if you "put these vars" in another block
(or blocks). Experience shows that putting them all in one block and treating it
like another subproblem performs poorly. Since they are unconstrained in the
subproblems, they are all independent and the most efficient thing to do is to
treat each as its own block -- with really only 2 choices - set it at its UB or
LB. All of this can be done efficiently if I know which ones are master-only
vars.

Yes, the user defines all the vars in the core. But, without knowing which are in
the blocks, I don't know which are "master-only".


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


But for each block, convexDual affects the value of the reduced cost, but it has
no effect on which column I choose. The convexDual does not affect the subproblem
solution, only the solution value. Therefore, in the first call to solveRelaxed
(whichBlock = 1) I can use redCostX for all the variables and simultaneously find
the best column for each subproblem. Then when the other subproblems are called
(whichBlock >1) I simply take the column from the first call (do not solve again)
and return it. The convexDual did not affect that solution. Hope I  am making
sense here.



Yep. You are correct, convexDual does not effect the pricing. It only effects the
"check" for negative RC (if you choose to do that as a user - you don't need to
actually) and, the constructor for a DecompVar. The latter could be redesigned so
the user doesn't need to provide it and the internal adjusts it for you. Either
one, a change (or addition) in the API would make this cleaner. I will think
about this and get back to you.

